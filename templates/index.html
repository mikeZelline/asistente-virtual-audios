<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual Contrataci贸n P煤blica</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <div>
                    <h1> Asistente Virtual de Contrataci贸n P煤blica</h1>
                    <p>Tu asistente experto en SECOP y contrataci贸n p煤blica colombiana</p>
                </div>
                <a href="/logout" class="logout-button">Cerrar Sesi贸n</a>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                <div class="message-content">
                    隆Hola! Soy tu asistente virtual especializado en contrataci贸n p煤blica y el SECOP. Preg煤ntame lo que necesites saber.
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form id="chatForm">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Escribe tu pregunta aqu铆..." 
                    autocomplete="off"
                >
                <button type="button" id="recordButton" class="record-button" title="Grabar audio">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </button>
                <button type="submit" id="sendButton">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </form>
            <div id="recordingStatus" class="recording-status" style="display: none;">
                <span class="recording-dot"></span>
                <span>Grabando...</span>
                <button id="stopRecordingButton" class="stop-recording-button">Detener</button>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const recordButton = document.getElementById('recordButton');
        const stopRecordingButton = document.getElementById('stopRecordingButton');
        const recordingStatus = document.getElementById('recordingStatus');
        
        let isRecording = false;

        // Variable global para controlar el audio actual
        let currentAudioMessageDiv = null;
        let stopAudioButton = null;

        // Funci贸n para agregar mensaje al chat
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Contenedor para el texto
            const textDiv = document.createElement('div');
            textDiv.textContent = message;
            messageContent.appendChild(textDiv);
            
            // Si es mensaje del bot, agregar bot贸n de pausa
            if (!isUser && 'speechSynthesis' in window) {
                const audioControlsDiv = document.createElement('div');
                audioControlsDiv.className = 'audio-controls';
                audioControlsDiv.style.marginTop = '8px';
                audioControlsDiv.style.display = 'flex';
                audioControlsDiv.style.alignItems = 'center';
                audioControlsDiv.style.gap = '8px';
                
                stopAudioButton = document.createElement('button');
                stopAudioButton.className = 'stop-audio-button';
                stopAudioButton.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                        <rect x="6" y="4" width="4" height="16" rx="1"></rect>
                        <rect x="14" y="4" width="4" height="16" rx="1"></rect>
                    </svg>
                `;
                stopAudioButton.title = 'Pausar audio';
                stopAudioButton.style.display = 'none'; // Oculto inicialmente
                
                stopAudioButton.addEventListener('click', () => {
                    window.speechSynthesis.cancel();
                    if (stopAudioButton) {
                        stopAudioButton.style.display = 'none';
                    }
                    currentAudioMessageDiv = null;
                });
                
                audioControlsDiv.appendChild(stopAudioButton);
                messageContent.appendChild(audioControlsDiv);
                
                // Guardar referencia al mensaje actual
                currentAudioMessageDiv = messageDiv;
            }
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            // Scroll al final
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Si es mensaje del bot, reproducir audio autom谩ticamente
            if (!isUser && 'speechSynthesis' in window) {
                speakText(message, stopAudioButton);
            }
        }
        
        // ===== CONFIGURACIN DE VOZ =====
        // Cambia este n煤mero (0, 1, 2, etc.) para seleccionar la voz
        // Este n煤mero corresponde a la POSICIN en la lista de voces en espa帽ol disponibles
        const VOZ_SELECCIONADA = 1; // 0 = primera voz en espa帽ol, 1 = segunda, etc.
        
        // Array de referencia (solo para documentaci贸n - no se usa en la selecci贸n)
        // Las voces se seleccionan por 铆ndice directamente del navegador
        const VOCES_DISPONIBLES = [
            'Microsoft Raul - Spanish (Mexico)',          // Voz 0 - Masculina M茅xico
            'Microsoft Sabina - Spanish (Mexico)',      // Voz 1 - Femenina M茅xico
            'Google espa帽ol',                            // Voz 2 - Google
            'Google espa帽ol de Estados Unidos',          // Voz 3 - Google Estados Unidos
        ];
        // ===== FIN CONFIGURACIN =====

        // Funci贸n para obtener voces (con reintento si no est谩n cargadas)
        function getVoices() {
            let voices = window.speechSynthesis.getVoices();
            // Si no hay voces, esperar un momento y reintentar
            if (voices.length === 0) {
                // Forzar carga de voces
                window.speechSynthesis.getVoices();
                voices = window.speechSynthesis.getVoices();
            }
            return voices;
        }

        // Funci贸n para convertir texto a voz y reproducirlo
        function speakText(text, stopButton) {
            // Cancelar cualquier s铆ntesis anterior
            window.speechSynthesis.cancel();
            
            // Ocultar bot贸n anterior si existe
            if (stopAudioButton && stopAudioButton !== stopButton) {
                stopAudioButton.style.display = 'none';
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.rate = 1.0; // Velocidad normal
            utterance.pitch = 1.0; // Tono normal
            utterance.volume = 1.0; // Volumen m谩ximo
            
            // Obtener todas las voces disponibles
            const voices = getVoices();
            
            // Filtrar solo voces en espa帽ol
            const vocesEspanol = voices.filter(voice => voice.lang.startsWith('es'));
            
            // Seleccionar la voz por 铆ndice directamente del array de voces en espa帽ol
            let selectedVoice = null;
            if (VOZ_SELECCIONADA >= 0 && VOZ_SELECCIONADA < vocesEspanol.length) {
                selectedVoice = vocesEspanol[VOZ_SELECCIONADA];
                console.log(`Voz seleccionada (铆ndice ${VOZ_SELECCIONADA}):`, selectedVoice.name);
            } else {
                // Si el 铆ndice no es v谩lido, usar la primera voz en espa帽ol
                if (vocesEspanol.length > 0) {
                    selectedVoice = vocesEspanol[0];
                    console.warn(`ndice ${VOZ_SELECCIONADA} inv谩lido. Usando primera voz disponible:`, selectedVoice.name);
                } else {
                    console.warn('No hay voces en espa帽ol disponibles');
                }
            }
            
            // Debug: mostrar todas las voces en espa帽ol disponibles con sus 铆ndices
            console.log('Voces en espa帽ol disponibles:');
            vocesEspanol.forEach((voz, index) => {
                console.log(`  [${index}] ${voz.name}`);
            });
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Mostrar bot贸n de pausa cuando empieza a reproducir
            if (stopButton) {
                stopButton.style.display = 'inline-flex';
            }
            
            // Eventos para ocultar el bot贸n cuando termine o se cancele
            utterance.onend = () => {
                if (stopButton) {
                    stopButton.style.display = 'none';
                }
                currentAudioMessageDiv = null;
            };
            
            utterance.onerror = () => {
                if (stopButton) {
                    stopButton.style.display = 'none';
                }
                currentAudioMessageDiv = null;
            };
            
            // Reproducir
            window.speechSynthesis.speak(utterance);
        }

        // Funci贸n para mostrar indicador de carga
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            
            typingDiv.appendChild(messageContent);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Funci贸n para remover indicador de carga
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Funci贸n para verificar y solicitar permisos del micr贸fono
        // Usa getUserMedia directamente para que el navegador muestre el di谩logo de permisos
        async function requestMicrophonePermission() {
            try {
                // Verificar que getUserMedia est茅 disponible
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Tu navegador no soporta acceso al micr贸fono. Por favor, usa un navegador moderno como Chrome, Edge o Firefox.');
                    return false;
                }
                
                // Usar getUserMedia directamente - esto mostrar谩 el di谩logo del navegador autom谩ticamente
                // si el permiso no est谩 otorgado
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Detener el stream inmediatamente, solo quer铆amos verificar/solicitar el permiso
                stream.getTracks().forEach(track => track.stop());
                
                return true;
            } catch (error) {
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    // El usuario deneg贸 el permiso en el di谩logo del navegador
                    alert('Se necesita permiso para usar el micr贸fono. Por favor, recarga la p谩gina y permite el acceso cuando se te solicite.');
                    return false;
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    alert('No se encontr贸 ning煤n micr贸fono. Por favor, conecta un micr贸fono e intenta de nuevo.');
                    return false;
                } else {
                    console.error('Error al solicitar permiso del micr贸fono:', error);
                    alert('Error al acceder al micr贸fono. Por favor, verifica la configuraci贸n de tu navegador.');
                    return false;
                }
            }
        }

        // Funci贸n para iniciar grabaci贸n con Web Speech API
        async function startRecording() {
            // Verificar si el navegador soporta Web Speech API
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Tu navegador no soporta reconocimiento de voz. Por favor, usa Chrome, Edge o Safari.');
                return;
            }
            
            // Solicitar permiso del micr贸fono antes de iniciar
            const hasPermission = await requestMicrophonePermission();
            if (!hasPermission) {
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recordButton.style.display = 'none';
            recordingStatus.style.display = 'flex';
            userInput.disabled = true;
            sendButton.disabled = true;
            
            recognition.onstart = () => {
                isRecording = true;
            };
            
            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                console.log("TRANSCRIPT: ");
                console.log(transcript);
                if (transcript.trim()) {
                    // Agregar mensaje del usuario con el texto transcrito
                    addMessage(transcript, true);
                    
                    // Enviar pregunta al chat (sin audio)
                    await sendChatMessage(transcript, false);
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Error en reconocimiento de voz:', event.error);
                let errorMsg = 'Error en el reconocimiento de voz.';
                if (event.error === 'no-speech') {
                    errorMsg = 'No se detect贸 habla. Intenta de nuevo.';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'Permiso de micr贸fono denegado. Por favor, permite el acceso al micr贸fono en la configuraci贸n de tu navegador.';
                }
                addMessage(errorMsg, false);
                stopRecording();
            };
            
            recognition.onend = () => {
                stopRecording();
            };
            
            try {
                recognition.start();
                // Guardar referencia para poder detenerla
                window.currentRecognition = recognition;
            } catch (error) {
                console.error('Error al iniciar reconocimiento:', error);
                addMessage('Error al iniciar la grabaci贸n. Por favor, intenta de nuevo.', false);
                stopRecording();
            }
        }
        
        // Funci贸n para detener grabaci贸n
        function stopRecording() {
            if (window.currentRecognition && isRecording) {
                window.currentRecognition.stop();
            }
            isRecording = false;
            recordButton.style.display = 'flex';
            recordingStatus.style.display = 'none';
            userInput.disabled = false;
            sendButton.disabled = false;
            userInput.focus();
        }
        
        // Funci贸n para enviar mensaje al chat
        async function sendChatMessage(question, generateAudio = false) {
            // Deshabilitar input mientras se procesa
            userInput.disabled = true;
            sendButton.disabled = true;
            recordButton.disabled = true;
            
            // Mostrar indicador de escritura
            showTypingIndicator();
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: question
                    })
                });
                
                const data = await response.json();
                
                // Remover indicador de escritura
                removeTypingIndicator();
                
                if (response.ok) {
                    addMessage(data.answer, false);
                } else {
                    addMessage('Error: ' + (data.error || 'Algo sali贸 mal'), false);
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('Error de conexi贸n: ' + error.message, false);
            } finally {
                // Rehabilitar input
                userInput.disabled = false;
                sendButton.disabled = false;
                recordButton.disabled = false;
                userInput.focus();
            }
        }
        
        // Manejar env铆o del formulario
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const question = userInput.value.trim();
            if (!question) return;
            
            // Agregar mensaje del usuario
            addMessage(question, true);
            userInput.value = '';
            
            // Enviar mensaje (sin audio)
            await sendChatMessage(question, false);
        });
        
        // Event listeners para grabaci贸n
        recordButton.addEventListener('click', startRecording);
        stopRecordingButton.addEventListener('click', stopRecording);
        
        // Cargar voces disponibles al iniciar (necesario para algunos navegadores)
        if ('speechSynthesis' in window) {
            // Algunos navegadores cargan las voces de forma as铆ncrona
            window.speechSynthesis.onvoiceschanged = () => {
                // Las voces est谩n disponibles ahora
            };
            // Intentar cargar voces inmediatamente
            window.speechSynthesis.getVoices();
        }

        // Focus autom谩tico en el input
        userInput.focus();
    </script>
</body>
</html>

